#!/bin/bash

# ============================================================================
# ä¼ä¸šçº§ NestJS åç«¯ç³»ç»Ÿ - PM2 æµ‹è¯•ç¯å¢ƒéƒ¨ç½²è„šæœ¬ (Bash)
# ============================================================================
# æè¿°: ç”¨äºæµ‹è¯•ç¯å¢ƒçš„ PM2 è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
# ç”¨æ³•: ./scripts/pm2-deploy-test.sh
# æ”¯æŒ: Linux / macOS
# ============================================================================

# è®¾ç½®é”™è¯¯å¤„ç†ï¼šé‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
set -e

# ============================================================================
# é¢œè‰²å®šä¹‰
# ============================================================================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ============================================================================
# è¾…åŠ©å‡½æ•°
# ============================================================================

print_title() {
    echo ""
    echo -e "${CYAN}ğŸš€ $1${NC}"
    echo "======================================================================"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_info() {
    echo -e "${BLUE}ğŸ“‹ $1${NC}"
}

command_exists() {
    command -v "$1" &> /dev/null
}

execute_command() {
    local cmd="$1"
    local error_msg="$2"
    
    if ! eval "$cmd"; then
        print_error "$error_msg"
        exit 1
    fi
}

# ============================================================================
# ä¸»è„šæœ¬å¼€å§‹
# ============================================================================

print_title "ä¼ä¸šçº§ NestJS åç«¯ç³»ç»Ÿ - PM2 æµ‹è¯•ç¯å¢ƒéƒ¨ç½²"

# ============================================================================
# 1. æ£€æŸ¥ç¯å¢ƒä¾èµ–
# ============================================================================
print_info "æ£€æŸ¥ç¯å¢ƒä¾èµ–..."

if ! command_exists node; then
    print_error "æœªå®‰è£… Node.jsï¼Œè¯·å…ˆå®‰è£… Node.js 22.x+"
    exit 1
fi

NODE_VERSION=$(node -v | cut -d'v' -f2 | cut -d'.' -f1)
if [ "$NODE_VERSION" -lt 22 ]; then
    print_error "Node.js ç‰ˆæœ¬è¿‡ä½ (å½“å‰: $(node -v))ï¼Œéœ€è¦ v22.0.0+"
    exit 1
fi
print_success "Node.js ç‰ˆæœ¬æ£€æŸ¥é€šè¿‡: $(node -v)"

if ! command_exists pnpm; then
    print_error "æœªå®‰è£… pnpmï¼Œè¯·å…ˆå®‰è£… pnpm"
    exit 1
fi
print_success "pnpm ç‰ˆæœ¬: $(pnpm -v)"

if ! command_exists pm2; then
    print_error "æœªå®‰è£… PM2ï¼Œè¯·å…ˆå®‰è£… PM2"
    exit 1
fi
print_success "PM2 ç‰ˆæœ¬: $(pm2 -v)"

# ============================================================================
# 2. æ£€æŸ¥é…ç½®æ–‡ä»¶
# ============================================================================
print_info "æ£€æŸ¥é…ç½®æ–‡ä»¶..."

if [ ! -f ".env.test" ]; then
    print_error "ç¼ºå°‘ .env.test é…ç½®æ–‡ä»¶"
    exit 1
fi
print_success ".env.test é…ç½®æ–‡ä»¶å­˜åœ¨"

if [ ! -f "ecosystem.config.js" ]; then
    print_error "ç¼ºå°‘ ecosystem.config.js PM2 é…ç½®æ–‡ä»¶"
    exit 1
fi
print_success "ecosystem.config.js é…ç½®æ–‡ä»¶å­˜åœ¨"

# ============================================================================
# 3. å®‰è£…ä¾èµ–
# ============================================================================
print_info "å®‰è£…ä¾èµ–..."
execute_command "pnpm install" "ä¾èµ–å®‰è£…å¤±è´¥"
print_success "ä¾èµ–å®‰è£…å®Œæˆ"

# ============================================================================
# 4. æ„å»ºé¡¹ç›®
# ============================================================================
print_info "æ„å»ºé¡¹ç›®..."
execute_command "pnpm build" "é¡¹ç›®æ„å»ºå¤±è´¥"
print_success "é¡¹ç›®æ„å»ºå®Œæˆ"

if [ ! -d "dist" ]; then
    print_error "æ„å»ºäº§ç‰© dist ç›®å½•ä¸å­˜åœ¨"
    exit 1
fi
print_success "æ„å»ºäº§ç‰©æ£€æŸ¥é€šè¿‡"

# ============================================================================
# 5. æ•°æ®åº“è¿ç§»
# ============================================================================
print_info "æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
echo ""
read -p "æ˜¯å¦æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼Ÿ(y/n): " migrate_confirm

if [ "$migrate_confirm" == "y" ] || [ "$migrate_confirm" == "Y" ]; then
    execute_command "pnpm db:migrate:deploy:test" "æ•°æ®åº“è¿ç§»å¤±è´¥"
    print_success "æ•°æ®åº“è¿ç§»å®Œæˆ"
else
    print_warning "è·³è¿‡æ•°æ®åº“è¿ç§»"
fi

# ============================================================================
# 6. å¯åŠ¨/é‡è½½ PM2 åº”ç”¨
# ============================================================================
print_info "éƒ¨ç½² PM2 åº”ç”¨..."

if pm2 describe nest-api-test &> /dev/null; then
    print_info "æ£€æµ‹åˆ°å·²å­˜åœ¨çš„åº”ç”¨ï¼Œæ‰§è¡Œé›¶åœæœºé‡è½½..."
    execute_command "pm2 reload ecosystem.config.js --env test --only nest-api-test" "PM2 é‡è½½å¤±è´¥"
    print_success "åº”ç”¨é‡è½½å®Œæˆ (é›¶åœæœºéƒ¨ç½²)"
else
    print_info "é¦–æ¬¡éƒ¨ç½²ï¼Œå¯åŠ¨åº”ç”¨..."
    execute_command "pm2 start ecosystem.config.js --env test --only nest-api-test" "PM2 å¯åŠ¨å¤±è´¥"
    print_success "åº”ç”¨å¯åŠ¨å®Œæˆ"
fi

# ============================================================================
# 7. ä¿å­˜ PM2 é…ç½®
# ============================================================================
print_info "ä¿å­˜ PM2 é…ç½®..."
execute_command "pm2 save" "PM2 é…ç½®ä¿å­˜å¤±è´¥"
print_success "PM2 é…ç½®å·²ä¿å­˜"

# ============================================================================
# 8. å¥åº·æ£€æŸ¥
# ============================================================================
print_info "ç­‰å¾…åº”ç”¨å¯åŠ¨..."
sleep 5

print_info "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
if command_exists curl; then
    PORT=$(grep "^PORT=" .env.test | cut -d'=' -f2 || echo "8001")
    
    if curl -f -s "http://localhost:${PORT}/health" > /dev/null; then
        print_success "å¥åº·æ£€æŸ¥é€šè¿‡ï¼åº”ç”¨è¿è¡Œæ­£å¸¸"
    else
        print_warning "å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åº”ç”¨æ—¥å¿—"
        echo "æŸ¥çœ‹æ—¥å¿—: pm2 logs nest-api-test"
    fi
else
    print_warning "æœªå®‰è£… curlï¼Œè·³è¿‡å¥åº·æ£€æŸ¥"
fi

# ============================================================================
# 9. æ˜¾ç¤ºåº”ç”¨çŠ¶æ€
# ============================================================================
echo ""
print_title "éƒ¨ç½²å®Œæˆï¼åº”ç”¨çŠ¶æ€å¦‚ä¸‹ï¼š"
pm2 status

echo ""
print_title "å¸¸ç”¨å‘½ä»¤ï¼š"
echo "  æŸ¥çœ‹æ—¥å¿—:   pm2 logs nest-api-test"
echo "  æŸ¥çœ‹ç›‘æ§:   pm2 monit"
echo "  é‡å¯åº”ç”¨:   pm2 restart nest-api-test"
echo "  åœæ­¢åº”ç”¨:   pm2 stop nest-api-test"
echo "  åˆ é™¤åº”ç”¨:   pm2 delete nest-api-test"
echo ""

print_success "ğŸ‰ æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"

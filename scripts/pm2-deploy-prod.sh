#!/bin/bash

# ============================================================================
# ä¼ä¸šçº§ NestJS åç«¯ç³»ç»Ÿ - PM2 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è„šæœ¬ (Bash)
# ============================================================================
# æè¿°: ç”¨äºç”Ÿäº§ç¯å¢ƒçš„ PM2 è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
# ç”¨æ³•: ./scripts/pm2-deploy-prod.sh
# è­¦å‘Š: æ­¤è„šæœ¬å°†éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œè¯·è°¨æ…ä½¿ç”¨ï¼
# æ”¯æŒ: Linux / macOS
# ============================================================================

# è®¾ç½®é”™è¯¯å¤„ç†ï¼šé‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
set -e

# ============================================================================
# é¢œè‰²å®šä¹‰
# ============================================================================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ============================================================================
# è¾…åŠ©å‡½æ•°
# ============================================================================

# æ˜¾ç¤ºæ ‡é¢˜ä¿¡æ¯
print_title() {
    echo ""
    echo -e "${CYAN}ğŸš€ $1${NC}"
    echo "======================================================================"
}

# æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

# æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

# æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# æ˜¾ç¤ºä¿¡æ¯
print_info() {
    echo -e "${BLUE}ğŸ“‹ $1${NC}"
}

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
command_exists() {
    command -v "$1" &> /dev/null
}

# æ‰§è¡Œå‘½ä»¤å¹¶æ£€æŸ¥ç»“æœ
execute_command() {
    local cmd="$1"
    local error_msg="$2"
    
    if ! eval "$cmd"; then
        print_error "$error_msg"
        exit 1
    fi
}

# ============================================================================
# ä¸»è„šæœ¬å¼€å§‹
# ============================================================================

print_title "ä¼ä¸šçº§ NestJS åç«¯ç³»ç»Ÿ - PM2 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²"

# ============================================================================
# 1. éƒ¨ç½²ç¡®è®¤
# ============================================================================
echo ""
echo -e "${RED}âš ï¸  è­¦å‘Š: æ­¤æ“ä½œå°†éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼${NC}"
echo ""
read -p "è¯·è¾“å…¥ 'YES' ç¡®è®¤ç»§ç»­éƒ¨ç½²: " confirmation

if [ "$confirmation" != "YES" ]; then
    print_info "éƒ¨ç½²å·²å–æ¶ˆ"
    exit 0
fi

echo ""

# ============================================================================
# 2. æ£€æŸ¥ç¯å¢ƒä¾èµ–
# ============================================================================
print_info "æ£€æŸ¥ç¯å¢ƒä¾èµ–..."

# æ£€æŸ¥ Node.js
if ! command_exists node; then
    print_error "æœªå®‰è£… Node.jsï¼Œè¯·å…ˆå®‰è£… Node.js 22.x+"
    echo "ä¸‹è½½åœ°å€: https://nodejs.org/"
    exit 1
fi

NODE_VERSION=$(node -v | cut -d'v' -f2 | cut -d'.' -f1)
if [ "$NODE_VERSION" -lt 22 ]; then
    print_error "Node.js ç‰ˆæœ¬è¿‡ä½ (å½“å‰: $(node -v))ï¼Œéœ€è¦ v22.0.0+"
    exit 1
fi
print_success "Node.js ç‰ˆæœ¬æ£€æŸ¥é€šè¿‡: $(node -v)"

# æ£€æŸ¥ pnpm
if ! command_exists pnpm; then
    print_error "æœªå®‰è£… pnpmï¼Œè¯·å…ˆå®‰è£… pnpm"
    echo "å®‰è£…å‘½ä»¤: npm install -g pnpm@9"
    exit 1
fi
print_success "pnpm ç‰ˆæœ¬: $(pnpm -v)"

# æ£€æŸ¥ PM2
if ! command_exists pm2; then
    print_error "æœªå®‰è£… PM2ï¼Œè¯·å…ˆå®‰è£… PM2"
    echo "å®‰è£…å‘½ä»¤: npm install -g pm2"
    exit 1
fi
print_success "PM2 ç‰ˆæœ¬: $(pm2 -v)"

# ============================================================================
# 3. æ£€æŸ¥é…ç½®æ–‡ä»¶
# ============================================================================
print_info "æ£€æŸ¥é…ç½®æ–‡ä»¶..."

if [ ! -f ".env.production" ]; then
    print_error "ç¼ºå°‘ .env.production é…ç½®æ–‡ä»¶"
    echo "è¯·å…ˆåˆ›å»º .env.production æ–‡ä»¶å¹¶é…ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡"
    exit 1
fi
print_success ".env.production é…ç½®æ–‡ä»¶å­˜åœ¨"

if [ ! -f "ecosystem.config.js" ]; then
    print_error "ç¼ºå°‘ ecosystem.config.js PM2 é…ç½®æ–‡ä»¶"
    exit 1
fi
print_success "ecosystem.config.js é…ç½®æ–‡ä»¶å­˜åœ¨"

# ============================================================================
# 4. æ‹‰å–æœ€æ–°ä»£ç ï¼ˆå¯é€‰ï¼Œæ ¹æ®å®é™…æƒ…å†µå¯ç”¨ï¼‰
# ============================================================================
# print_info "æ‹‰å–æœ€æ–°ä»£ç ..."
# if [ -d ".git" ]; then
#     execute_command "git pull origin main" "Git æ‹‰å–ä»£ç å¤±è´¥"
#     print_success "ä»£ç æ›´æ–°å®Œæˆ"
# else
#     print_warning "é Git ä»“åº“ï¼Œè·³è¿‡ä»£ç æ‹‰å–"
# fi

# ============================================================================
# 5. å®‰è£…ä¾èµ–
# ============================================================================
print_info "å®‰è£…ä¾èµ–..."
execute_command "pnpm install --prod --frozen-lockfile" "ä¾èµ–å®‰è£…å¤±è´¥"
print_success "ä¾èµ–å®‰è£…å®Œæˆ"

# ============================================================================
# 6. æ„å»ºé¡¹ç›®
# ============================================================================
print_info "æ„å»ºé¡¹ç›®..."
execute_command "pnpm build" "é¡¹ç›®æ„å»ºå¤±è´¥"
print_success "é¡¹ç›®æ„å»ºå®Œæˆ"

# æ£€æŸ¥æ„å»ºäº§ç‰©
if [ ! -d "dist" ]; then
    print_error "æ„å»ºäº§ç‰© dist ç›®å½•ä¸å­˜åœ¨"
    exit 1
fi
print_success "æ„å»ºäº§ç‰©æ£€æŸ¥é€šè¿‡"

# ============================================================================
# 7. æ•°æ®åº“è¿ç§»
# ============================================================================
print_info "æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
echo ""
read -p "æ˜¯å¦æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼Ÿ(y/n): " migrate_confirm

if [ "$migrate_confirm" == "y" ] || [ "$migrate_confirm" == "Y" ]; then
    execute_command "pnpm db:migrate:deploy" "æ•°æ®åº“è¿ç§»å¤±è´¥"
    print_success "æ•°æ®åº“è¿ç§»å®Œæˆ"
else
    print_warning "è·³è¿‡æ•°æ®åº“è¿ç§»"
fi

# ============================================================================
# 8. å¯åŠ¨/é‡è½½ PM2 åº”ç”¨
# ============================================================================
print_info "éƒ¨ç½² PM2 åº”ç”¨..."

# æ£€æŸ¥åº”ç”¨æ˜¯å¦å·²å­˜åœ¨
if pm2 describe nest-api-prod &> /dev/null; then
    print_info "æ£€æµ‹åˆ°å·²å­˜åœ¨çš„åº”ç”¨ï¼Œæ‰§è¡Œé›¶åœæœºé‡è½½..."
    execute_command "pm2 reload ecosystem.config.js --env production --only nest-api-prod" "PM2 é‡è½½å¤±è´¥"
    print_success "åº”ç”¨é‡è½½å®Œæˆ (é›¶åœæœºéƒ¨ç½²)"
else
    print_info "é¦–æ¬¡éƒ¨ç½²ï¼Œå¯åŠ¨åº”ç”¨..."
    execute_command "pm2 start ecosystem.config.js --env production --only nest-api-prod" "PM2 å¯åŠ¨å¤±è´¥"
    print_success "åº”ç”¨å¯åŠ¨å®Œæˆ"
fi

# ============================================================================
# 9. ä¿å­˜ PM2 é…ç½®
# ============================================================================
print_info "ä¿å­˜ PM2 é…ç½®..."
execute_command "pm2 save" "PM2 é…ç½®ä¿å­˜å¤±è´¥"
print_success "PM2 é…ç½®å·²ä¿å­˜"

# ============================================================================
# 10. å¥åº·æ£€æŸ¥
# ============================================================================
print_info "ç­‰å¾…åº”ç”¨å¯åŠ¨..."
sleep 5

print_info "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
if command_exists curl; then
    # ä» .env.production è¯»å–ç«¯å£ï¼ˆé»˜è®¤ 8002ï¼‰
    PORT=$(grep "^PORT=" .env.production | cut -d'=' -f2 || echo "8002")
    
    if curl -f -s "http://localhost:${PORT}/health" > /dev/null; then
        print_success "å¥åº·æ£€æŸ¥é€šè¿‡ï¼åº”ç”¨è¿è¡Œæ­£å¸¸"
    else
        print_warning "å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åº”ç”¨æ—¥å¿—"
        echo "æŸ¥çœ‹æ—¥å¿—: pm2 logs nest-api-prod"
    fi
else
    print_warning "æœªå®‰è£… curlï¼Œè·³è¿‡å¥åº·æ£€æŸ¥"
fi

# ============================================================================
# 11. æ˜¾ç¤ºåº”ç”¨çŠ¶æ€
# ============================================================================
echo ""
print_title "éƒ¨ç½²å®Œæˆï¼åº”ç”¨çŠ¶æ€å¦‚ä¸‹ï¼š"
pm2 status

echo ""
print_title "å¸¸ç”¨å‘½ä»¤ï¼š"
echo "  æŸ¥çœ‹æ—¥å¿—:   pm2 logs nest-api-prod"
echo "  æŸ¥çœ‹ç›‘æ§:   pm2 monit"
echo "  é‡å¯åº”ç”¨:   pm2 restart nest-api-prod"
echo "  åœæ­¢åº”ç”¨:   pm2 stop nest-api-prod"
echo "  åˆ é™¤åº”ç”¨:   pm2 delete nest-api-prod"
echo ""

print_success "ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
